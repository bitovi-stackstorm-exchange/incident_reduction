version: 1.0

description: Receiver for alerts of type 4xx

input:
  - alert_data

tasks:
  splunk:
    # TODO: hook up to splunk
    # action: splunk.query
    # input:

    ### delete this ###
    action: core.noop
    ### end delete this ###
    next:
      - when: <% succeeded() %> 
        publish:
          # TODO: extract splunk
          # - splunk_result: <% task(splunk).result %>

          ### delete this ###
          - splunk_result: 
            DT: "iPhone"
          ### end delete this ###xs
        do: check_splunk_response


  check_splunk_response:
    action: core.noop
    next:
      # TODO: need to add specific business logic
      - when: <% succeeded() and ctx().splunk_result.DT = "iPhone" %>
        do: force_close
      - when: <% succeeded() and ctx().splunk_result.DT != "iPhone" %>
        do: set_visible

  set_visible:
    # TODO: change this to an action to call bosun api
    action: core.echo message="call api to set visible - alert_id(<% ctx().alert_data.id) %>"
    # TODO add
    # input:
    #   alert_id: <% ctx().alert_data.id %>

  # TODO: change this to an action to call bosun api
  force_close:
    action: core.echo message="force close - alert_id(<% ctx().alert_data.id) %>"